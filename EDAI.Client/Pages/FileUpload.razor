@page "/fileupload"
@using System.Text.Json
@using System.Text.Json.Serialization
@using DocumentFormat.OpenXml.InkML
@using EDAI.Client.Components
@using EDAI.Shared.Exceptions
@using EDAI.Shared.Models
@using EDAI.Shared.Models.DTO
@using EDAI.Shared.Models.Entities
@using EDAI.Shared.Models.Enums
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient _Client
@inject IDialogService DialogService
@using MudBlazor.Interfaces
@inject NavigationManager Navigation


<PageTitle>File Upload</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">File Upload</MudText>

<MudGrid>
    <MudItem xs="2">
        <MudSelect T="AssignmentDTO" @bind-Value="_assignment" Placeholder="Select Assignment" Label="Assignment">
            @foreach (var assignment in _assignments)
            {
                <MudSelectItem Value="assignment">@assignment.Name</MudSelectItem>
            }
        </MudSelect>        
    </MudItem>
    <MudItem xs="2">
        <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.Create" @onclick="OpenDialogAsync">Create Assignment</MudButton>
    </MudItem>
    @if (_assignmentCreated)
    {
    <MudItem xs="2" Class="justify-end">
        <MudChip  T="string" Color="Color.Success" Variant="Variant.Text">Assignment Created</MudChip>
    </MudItem>
    }
    <MudItem xs=@(!_assignmentCreated && _assignment == null ? 8:4) Class="justify-end" >
        <MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".docx" FilesChanged="UploadFiles">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.UploadFile"
                           Disabled="@(_assignment == null)">
                    Upload Files
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>
    </MudItem>
    
    @if (_essays.Any())
    {
        <MudItem xs = "12">
            <MudDataGrid MultiSelection="true" T="EssayFileDTO" Items="_essays" ReadOnly="false" EditMode="DataGridEditMode.Cell" Bordered="false" Dense="false">
                <Columns>
                    <PropertyColumn Property="x => x.Document.DocumentName" Title="File Name" Editable="false"/>
                    <PropertyColumn Property="x => x.Student.FullName" Title="Student" Editable="true">
                        <EditTemplate>
                            <MudAutocomplete  Immediate="true" @bind-Value="context.Item.Student.FullName" SearchFunc="SearchFirstName" Required="true" RequiredError="Please Specify First Name"/>
                        </EditTemplate>
                    </PropertyColumn>
                    <TemplateColumn>
                        <EditTemplate>
                            @if (context.Item.Status == EssayStatus.AwaitingUpload)
                            {
                                <MudChip T="string">Awaiting Upload</MudChip>
                            }
                            else if (context.Item.Status == EssayStatus.Processing)
                            {
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                            }
                            else
                            {
                                <MudButton Size="Size.Large" Variant="Variant.Filled" Color="Color.Primary">
                                    Reviewed Essay
                                </MudButton>
                                
                            }
                            
                        </EditTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudItem>
        
        
        <MudItem xs = "2">
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Feedback" OnClick="SendFilesForReview">
                Review Files
            </MudButton>
        </MudItem>
        
        @if (!_validStudents)
        {
            <MudItem xs="2" Class="justify-end">
                <MudChip  T="string" Color="Color.Error" Variant="Variant.Text">Error in assigning students</MudChip>
            </MudItem>
        }
        @if (_filesUploadedSuccesfully)
        {
            <MudItem xs="2" Class="justify-end">
                <MudChip  T="string" Color="Color.Success" Variant="Variant.Text">Files Uploaded</MudChip>
            </MudItem>
        }
        @if (_errorInFilesUploaded)
        {
            <MudItem xs="2" Class="justify-end">
                <MudChip  T="string" Color="Color.Error" Variant="Variant.Text">Error in File Upload</MudChip>
            </MudItem>
        }
    }
</MudGrid>



@code {
    private HubConnection? _hubConnection;

    private string? _connectionString;
    
    private bool _validStudents = true;

    private bool _filesUploadedSuccesfully = false;
    
    private bool _errorInFilesUploaded = false;

    private const int _maxFileSize = 1024 * 1024 * 10; 

    private AssignmentDTO? _assignment;

    private bool _assignmentCreated = false;

    private IEnumerable<AssignmentDTO> _assignments = new List<AssignmentDTO>();

    private string _assignmentClass;

    private IEnumerable<StudentDTO> _students;

    private IList<EssayFileDTO> _essays = new List<EssayFileDTO>();

    private async Task UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        using var memoryStream = new MemoryStream();
        
        foreach (var file in files)
        {
            using var stream = file.OpenReadStream(_maxFileSize);
            await stream.CopyToAsync(memoryStream);

            _essays.Add(new EssayFileDTO
            {
                AssignmentId = _assignment.AssignmentId,
                Document = new EdaiDocument
                {
                    DocumentFile = memoryStream.ToArray(),
                    DocumentName = Path.GetFileNameWithoutExtension(file.Name),
                    DocumentFileExtension = Path.GetExtension(file.Name)
                },
                Student = new StudentDTO()
            });
        }
    }

    private async Task SendFilesForReview()
    {
        try
        {
            await AssignStudentIds();
        }
        catch (NoStudentException e)
        {
            _validStudents = false;
            return;
        }
        
        _validStudents = true;

        var essayResponse = await _Client.PostAsJsonAsync("Essay/bulk", _essays);
        
        if (essayResponse.IsSuccessStatusCode)
        {
            _errorInFilesUploaded = false;
            _filesUploadedSuccesfully = true;
            var essays = await essayResponse.Content.ReadFromJsonAsync<IEnumerable<EssayFileDTO>>();
            UpdateEssays(essays);
            var documentIds = essays.Select(e => e.Document.EdaiDocumentId);
            var request = new GenerateScoreRequestDTO
                { 
                    DocumentIds = documentIds,
                    ConnectionId = _connectionString
                };
            var scoreResponse = await _Client.PostAsJsonAsync("Score/generatescores", request);
            Console.WriteLine(scoreResponse.StatusCode);
        }
        else
        {
            _filesUploadedSuccesfully = false;
            _errorInFilesUploaded = true;
        }

    }

    private async Task UpdateEssays(IEnumerable<EssayFileDTO> essays)
    {
        foreach (var _essay in _essays)
        {
            _essay.EssayId = essays.Single(e => e.AssignmentId == _essay.AssignmentId &&
                                                e.Student.StudentId == _essay.Student.StudentId).EssayId;
            _essay.Status = EssayStatus.Processing;
        }
    }

    private async Task AssignStudentIds()
    {
        foreach (var esssay in _essays)
        {
            var studentMatches = _students.Where(s => s.FullName == esssay.Student.FullName);
            
            if (studentMatches.Count() == 1)
            {
                var matchedStudent = studentMatches.Single();

                esssay.Student.StudentId = matchedStudent.StudentId;
                esssay.Student.FirstName = matchedStudent.FirstName;
                esssay.Student.LastName = matchedStudent.LastName;
                esssay.Student.Class = matchedStudent.Class;
                esssay.Student.GraduationYear = matchedStudent.GraduationYear;
            }
            else
            {
                throw new NoStudentException();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var options = new JsonSerializerOptions()
        {
            ReferenceHandler = ReferenceHandler.Preserve,
            PropertyNameCaseInsensitive = true
        };

        _assignments = await _Client.GetFromJsonAsync<IEnumerable<AssignmentDTO>>("Assignment", options);

        _students = await _Client.GetFromJsonAsync<IEnumerable<StudentDTO>>("Student", options);

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/messagehub"))
            .WithAutomaticReconnect()
            .ConfigureLogging(logging => logging.SetMinimumLevel(LogLevel.Debug))
            .Build();

        _hubConnection.On<string>("ScoreGenerated",HandleReviewCompletion);

        await _hubConnection.StartAsync();
        _connectionString = _hubConnection.ConnectionId;
        
        Console.WriteLine($"SignalR state is {_hubConnection.State} with connectionId {_connectionString}");
    }

    private void HandleReviewCompletion(string essayId)
    {
        int id;
        var succes = int.TryParse(essayId, out id);

        if (!succes)
        {
            throw new InvalidCastException($"Id candidate {essayId} could not be converted to integer");
        }

        try
        {
            _essays.Single(e => e.EssayId == id).Status = EssayStatus.Reviewed;
            StateHasChanged();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
    }

    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraLarge,
            FullWidth = true,
            NoHeader    = true,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<AssignmentCreationDialog>("Create Assignment", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var httpOptions = new JsonSerializerOptions()
            {
                ReferenceHandler = ReferenceHandler.Preserve,
                PropertyNameCaseInsensitive = true
            };

            _assignments = await _Client.GetFromJsonAsync<IEnumerable<AssignmentDTO>>("Assignment", httpOptions);

            _assignmentCreated = true;
        }

    }

    private async Task<IEnumerable<string>> SearchFirstName(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return _students.Select(x => x.FullName).Distinct();

        return _students.Select(x => x.FullName).Where(firstName => firstName.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Distinct();
    }

}
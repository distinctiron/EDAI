@using System.Net.Http.Headers
@using System.Text.Json
@using System.Text.Json.Serialization
@using DocumentFormat.OpenXml.Wordprocessing
@using EDAI.Shared.Models.DTO
@using EDAI.Shared.Models.DTO.OpenAI
@using EDAI.Shared.Models.Enums
@using Color = MudBlazor.Color
@inject HttpClient _Client
@using Microsoft.AspNetCore.Http
<h3 class="pl-5 pt-5">Create Assignment</h3>

<MudGrid Class="p-5">
    @if (_createdAssignment)
    {
        <MudItem xs="12">
            <MudChip T="string" Color="Color.Success" Variant="Variant.Text">Assignment Created</MudChip>
        </MudItem>
    }
    <MudItem xs="12">
        <EditForm Model="@_assignmentDto" OnSubmit="CreateAssignmentAsync">
            <DataAnnotationsValidator/>
            <MudCard >
                <MudCardContent>
                    <MudTextField T="string" @bind-Value="_assignmentDto.Name" Label="Name of Assignment" Required="true" RequiredError="Specify the name of the assignment"/>
                    <MudTextField T="string" @bind-Value="_assignmentDto.Description" Label="Assignment Description" Required="true" RequiredError="Provide description of assignment"
                                  Variant="Variant.Outlined" Lines="6"/>
                    <MudSelect T="string" @bind-SelectedValues="_assignmentClasses" Label="Class" MultiSelection="true">
                        @foreach (var studentClass in _studentClasses)
                        {
                            <MudSelectItem T="string" Value="@studentClass">@studentClass</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="AssignmentType" @bind-Value="_assignmentType" Label="Assignment Type" MultiSelection="false">
                        @foreach (AssignmentType assignmentType in AssignmentType.GetValuesAsUnderlyingType<AssignmentType>())
                        {
                        <MudSelectItem T="AssignmentType" Value="@assignmentType">@assignmentType.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudCardContent>
                <div class="d-flex align-center justify-space-between">
                    <MudFileUpload Class="pl-5 pb-5" T="IReadOnlyList<IBrowserFile>" FilesChanged="UploadFiles" Accept=".pdf" Required="false">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.AttachFile">
                                Attach Reference Files
                            </MudButton>
                            @if (_referenceFiles is not null && _referenceFiles.Count > 0)
                            {
                                @foreach (var file in _referenceFiles)
                                {
                                    <MudChip T = "string"> @file.Name</MudChip>
                                }
                            }
                        </ActivatorContent>
                    </MudFileUpload>
                    <MudCardActions Class="pr-5 pb-5">
                        
                            @if (!_assignmentUnderCreation)
                            {
                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Create</MudButton>
                            }
                            else
                            {
                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">
                                    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
                                </MudButton>
                            }

                        
                    </MudCardActions>
                </div>
            </MudCard>
        </EditForm>
    </MudItem>
</MudGrid>

@code {

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }
    
    private bool _createdAssignment = false;
    private bool _assignmentUnderCreation = false;
    private string _selectedClass = String.Empty;
    private bool _validForm;
    private AssignmentDTO _assignmentDto = new AssignmentDTO();
    private IReadOnlyList<IBrowserFile> _referenceFiles;
    
    private const long maxFileSize = 10 * 1024 * 1024;

    private IEnumerable<string> _studentClasses = new List<string>();

    private IEnumerable<string> _assignmentClasses = new HashSet<string>();

    private AssignmentType _assignmentType;

    protected override async Task OnInitializedAsync()
    {
        var options = new JsonSerializerOptions()
        {
            ReferenceHandler = ReferenceHandler.Preserve,
            PropertyNameCaseInsensitive = true
        };

        var students = await _Client.GetFromJsonAsync<IEnumerable<StudentDTO>>("api/Student", options);

        _studentClasses = students.Select(x => x.Class).Distinct();
    }

    private async void CreateAssignmentAsync(EditContext context)
    {
        _assignmentUnderCreation = true;
        StateHasChanged();
        
        _assignmentDto.Open = true;
        _assignmentDto.StudentClasses = _assignmentClasses;
        _assignmentDto.AssignmentType = _assignmentType;

        var assignmentRepsonse = await _Client.PostAsJsonAsync("api/Assignment",_assignmentDto);

        var assignmentId = await assignmentRepsonse.Content.ReadFromJsonAsync<int>();

        if (_referenceFiles is not null && _referenceFiles.Count > 0)
        {
            foreach (var file in _referenceFiles)
            {
                using var content = new MultipartFormDataContent();
                var streamContent = new StreamContent(file.OpenReadStream(maxFileSize));

                streamContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            
                content.Add(content:streamContent, name:"\"file\"", fileName:file.Name); 
            
                var fileResponse = await _Client.PostAsync($"api/Assignment/{assignmentId}/uploadDocumentFile", content);

                if (!fileResponse.IsSuccessStatusCode)
                {
                    break;
                }
            }
            
            Task.Delay(500);
            MudDialog.Close(DialogResult.Ok(true));
        }
        else if(assignmentRepsonse.IsSuccessStatusCode)
        {
            Task.Delay(500);
            MudDialog.Close(DialogResult.Ok(true));
        }
        
        

        _createdAssignment = true;

        _assignmentDto = new AssignmentDTO();

        _referenceFiles = null;
        
        StateHasChanged();
    }

    private async Task UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        _referenceFiles = files;
    }
}